{% extends 'base.html' %}
{% block title %}{{ event.title }}{% endblock %}
{% block content %}
<div class="event-details">
    <h2>{{ event.title }}</h2>
    <p><strong>Category:</strong>
        {% if event.category %}
        {{ event.category.name }}
        {% else %}
        None
        {% endif %}
    </p>
    <p><strong>Date:</strong> {{ event.date.strftime('%Y-%m-%d %H:%M') }}</p>
    <p><strong>Location:</strong> {{ event.location }}</p>
    <p><strong>Organized by:</strong> {{ event.club.name }}</p>
    <p>{{ event.description }}</p>

    {% if current_user.is_authenticated %}
    {% set event_bookmarked = current_user.bookmarks|selectattr("event_id", "equalto", event.id)|list %}
    {% if event_bookmarked %}
    <a href="{{ url_for('bookmark.remove_event_bookmark', event_id=event.id) }}" class="btn btn-sm btn-warning">Remove
        Bookmark</a>
    {% else %}
    <a href="{{ url_for('bookmark.add_event_bookmark', event_id=event.id) }}" class="btn btn-sm btn-info">Bookmark This
        Event</a>
    {% endif %}
    {% endif %}

    <div class="event-registration">
        {% if current_user.is_authenticated %}
        {% if is_registered %}
        {% if status == 'confirmed' %}
        <p class="text-success">You are registered for this event.</p>
        <a href="{{ url_for('event.cancel_registration', event_id=event.id) }}" class="btn btn-danger">Cancel
            Registration</a>
        {% elif status == 'waiting' %}
        <p class="text-warning">You are on the waiting list for this event.</p>
        <a href="{{ url_for('event.cancel_registration', event_id=event.id) }}" class="btn btn-danger">Cancel
            Registration</a>
        {% endif %}
        {% else %}
        <a href="{{ url_for('event.register_event', event_id=event.id) }}" class="btn btn-primary">Register for
            Event</a>
        {% endif %}
        {% else %}
        <p><a href="{{ url_for('auth.login') }}" class="btn btn-secondary">Login</a> to register for this event.</p>
        {% endif %}
    </div>

    {% if current_user.is_authenticated and (event.club.president_id == current_user.id or current_user.is_main_admin)%}
    <a href="{{ url_for('poll.create_poll', event_id=event.id) }}" class="btn btn-sm btn-info">Create Poll</a>
    {% endif %}

    {% if event.polls %}
    <h3>Polls for this Event</h3>
    <ul>
        {% for poll in event.polls %}
        <li>
            <a href="{{ url_for('poll.view_poll', poll_id=poll.id) }}">{{ poll.question }}</a>
            ({{ poll.created_at.strftime('%Y-%m-%d') }})
        </li>
        {% endfor %}
    </ul>
    {% endif %}

    <div class="event-feedback">
        <h3>Feedback</h3>
        {% if average_rating %}
        <p><strong>Average Rating:</strong> {{ average_rating }} / 5</p>
        {% else %}
        <p>No feedback has been submitted for this event yet.</p>
        {% endif %}

        {% if current_user.is_authenticated and can_provide_feedback %}
        <a href="{{ url_for('event.submit_feedback', event_id=event.id) }}" class="btn btn-success">Submit Feedback</a>
        {% elif feedback_submitted %}
        <p>You have already submitted feedback for this event.</p>
        {% endif %}
    </div>

    {% if current_user.is_authenticated and event.club.president_id == current_user.id %}
    <div class="manage-attendees">
        <h3>Manage Attendees</h3>
        <a href="{{ url_for('event.manage_attendees', event_id=event.id) }}" class="btn btn-info">Manage Attendees</a>
    </div>
    {% endif %}

    {% if current_user.is_authenticated and event.club.president_id == current_user.id %}
    <form action="{{ url_for('resource.upload_resource', event_id=event.id) }}" method="POST"
        enctype="multipart/form-data">
        <label for="file">Upload Resource</label>
        <input type="file" name="file" id="file">
        <button type="submit" class="btn btn-primary">Upload</button>
    </form>
    {% endif %}
    {% if current_user.is_authenticated and (current_user.is_main_admin or event.club.president_id == current_user.id) %}
    <div class="event-manage">
        <a href="{{ url_for('event.edit_event', event_id=event.id) }}" class="btn btn-warning">Edit Event</a>
        <form action="{{ url_for('event.delete_event', event_id=event.id) }}" method="POST"
            onsubmit="return confirm('Are you sure you want to delete this event?');" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger">Delete Event</button>
        </form>
    </div>
    {% endif %}

    <h3>Event Resources</h3>
    {% if event.resources %}
    <ul>
        {% for res in event.resources %}
        <li>
            {{ res.filename }} (uploaded on {{ res.upload_date.strftime('%Y-%m-%d') }})
            <a href="{{ url_for('resource.download_resource', resource_id=res.id) }}"
                class="btn btn-sm btn-success">Download</a>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>No resources yet.</p>
    {% endif %}
</div>
{% endblock %}