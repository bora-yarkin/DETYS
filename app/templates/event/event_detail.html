{% extends 'base.html' %}
{% block title %}{{ event.title }}{% endblock %}
{% block content %}
<div class="event-details">
    <h2>{{ event.title }}</h2>
    <p><strong>Date:</strong> {{ event.date.strftime('%Y-%m-%d %H:%M') }}</p>
    <p><strong>Location:</strong> {{ event.location }}</p>
    <p><strong>Organized by:</strong> {{ event.club.name }}</p>
    <p>{{ event.description }}</p>

    <!-- Registration Section -->
    <div class="event-registration">
        {% if current_user.is_authenticated %}
        {% if is_registered %}
        {% if status == 'confirmed' %}
        <p class="text-success">You are registered for this event.</p>
        <a href="{{ url_for('event.cancel_registration', event_id=event.id) }}" class="btn btn-danger">Cancel
            Registration</a>
        {% elif status == 'waiting' %}
        <p class="text-warning">You are on the waiting list for this event.</p>
        <a href="{{ url_for('event.cancel_registration', event_id=event.id) }}" class="btn btn-danger">Cancel
            Registration</a>
        {% endif %}
        {% else %}
        <a href="{{ url_for('event.register_event', event_id=event.id) }}" class="btn btn-primary">Register for
            Event</a>
        {% endif %}
        {% else %}
        <p><a href="{{ url_for('auth.login') }}" class="btn btn-secondary">Login</a> to register for this event.</p>
        {% endif %}
    </div>

    <!-- Feedback Section -->
    <div class="event-feedback">
        <h3>Feedback</h3>
        {% if average_rating %}
        <p><strong>Average Rating:</strong> {{ average_rating }} / 5</p>
        {% else %}
        <p>No feedback has been submitted for this event yet.</p>
        {% endif %}

        {% if current_user.is_authenticated and can_provide_feedback %}
        <a href="{{ url_for('event.submit_feedback', event_id=event.id) }}" class="btn btn-success">Submit Feedback</a>
        {% elif feedback_submitted %}
        <p>You have already submitted feedback for this event.</p>
        {% endif %}
    </div>

    <!-- Manage Attendees (For Club Manager) -->
    {% if current_user.is_authenticated and event.club.president_id == current_user.id %}
    <div class="manage-attendees">
        <h3>Manage Attendees</h3>
        <a href="{{ url_for('event.manage_attendees', event_id=event.id) }}" class="btn btn-info">Manage Attendees</a>
    </div>
    {% endif %}
    <!-- In event_detail.html -->
    {% if current_user.is_authenticated and event.club.president_id == current_user.id %}
    <form action="{{ url_for('resource.upload_resource', event_id=event.id) }}" method="POST" enctype="multipart/form-data">
        <label for="file">Upload Resource</label>
        <input type="file" name="file" id="file">
        <button type="submit" class="btn btn-primary">Upload</button>
    </form>
    {% endif %}
    <!-- if event.club.president_id == current_user.id or user is main admin -->
    <a href="{{ url_for('poll.create_poll', event_id=event.id) }}">Create Poll</a>
    
    <!-- if event.polls exist -->
    {% for poll in event.polls %}
    <a href="{{ url_for('poll.view_poll', poll_id=poll.id) }}">{{ poll.question }}</a>
    {% endfor %}
    <!-- List of resources -->
    <h3>Event Resources</h3>
    {% if event.resources %}
    <ul>
        {% for res in event.resources %}
        <li>
            {{ res.filename }} (uploaded on {{ res.upload_date.strftime('%Y-%m-%d') }})
            <a href="{{ url_for('resource.download_resource', resource_id=res.id) }}"
                class="btn btn-sm btn-success">Download</a>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>No resources yet.</p>
    {% endif %}
</div>
{% endblock %}