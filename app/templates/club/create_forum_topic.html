{% extends 'base.html' %}
{% block title %}Create Forum Topic{% endblock %}
{% block content %}

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<h2>Create a Forum Topic</h2>

<form id="create-topic-form" method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    <div class="form-group">
        {{ form.title.label }}
        {{ form.title(class="form-control", placeholder="Enter topic title", required=True) }}
        {% for error in form.title.errors %}
        <span class="error">{{ error }}</span>
        {% endfor %}
    </div>

    <div class="form-group">
        {{ form.category_id.label }}
        {{ form.category_id(class="form-control") }}
        {% for error in form.category_id.errors %}
        <span class="error">{{ error }}</span>
        {% endfor %}
    </div>

    <div class="form-group">
        <label>Initial Post Content</label>
        <div id="editor" style="height: 300px; background: #fff;"></div>
        {% for error in form.content.errors %}
        <span class="error">{{ error }}</span>
        {% endfor %}
    </div>

    {{ form.content(id="content-textarea", style="position:absolute; top:-1000px; left:-1000px; width:1px; height:1px;
    opacity:0;", required=True) }}

    <button type="submit" class="btn btn-success">Create Topic</button>
</form>

<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
    function imageHandler() {
        let input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();

        input.onchange = () => {
            let file = input.files[0];
            if (file) {
                let formData = new FormData();
                formData.append('file', file);

                fetch("{{ url_for('main.upload_image') }}", {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.url) {
                            let range = quill.getSelection() || { index: quill.getLength() };
                            quill.insertEmbed(range.index, 'image', result.url, Quill.sources.USER);
                            quill.setSelection(range.index + 1);
                        } else {
                            alert("Image upload failed: " + (result.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Image upload error');
                    });
            }
        };
    }

    var quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: {
                container: [
                    [{ 'header': [1, 2, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['link', 'image', 'blockquote', 'code-block'],
                    ['clean']
                ],
                handlers: {
                    image: imageHandler
                }
            }
        }
    });

    quill.on('text-change', function () {
        let html = quill.root.innerHTML.trim();
        document.getElementById('content-textarea').value = html;
    });
</script>

{% endblock %}