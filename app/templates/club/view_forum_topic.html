{% extends 'base.html' %}
{% block title %}{{ topic.title }}{% endblock %}
{% block content %}
<h2>{{ topic.title }}</h2>
<p>Category: {{ topic.forum_category.name if topic.forum_category else "None" }}</p>
<p>Created on {{ topic.created_at.strftime('%Y-%m-%d %H:%M') }} by {{ topic.creator.username }}</p>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<hr>
<h4>Posts</h4>
{% if posts %}
<ul>
    {% for p in posts %}
    <li style="margin-bottom: 10px;">
        <strong>{{ p.user.username }}</strong> posted:
        <div>{{ p.content|safe }}</div>
        <small>Posted at {{ p.posted_at.strftime('%Y-%m-%d %H:%M') }}</small>
        <br>

        <small>Score: {{ p.score }}</small>
        <form action="{{ url_for('forum.vote_forum_post', post_id=p.id) }}" method="POST" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button name="vote_type" value="up" class="btn btn-sm btn-success">Upvote</button>
            <button name="vote_type" value="down" class="btn btn-sm btn-danger">Downvote</button>
        </form>
    </li>
    {% endfor %}
</ul>
{% else %}
<p>No posts yet. Be the first to reply!</p>
{% endif %}

<hr>
<form method="POST" action="{{ url_for('forum.add_forum_post', topic_id=topic.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

    <label>Add a Post:</label>
    <div id="editor" style="height: 150px;"></div>
    {{ post_form.content(id="post-content", style="display:none;") }}

    <button type="submit" class="btn btn-primary" style="margin-top:10px;">Submit</button>
</form>

{% if poll %}
<hr>
<h3>Poll: {{ poll.question }}</h3>
<form action="{{ url_for('forum.vote_forum_poll', poll_id=poll.id) }}" method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <ul>
        {% for choice in poll.choices %}
        <li>
            <label>
                <input type="radio" name="choice_id" value="{{ choice.id }}">
                {{ choice.choice_text }} ({{ choice.votes }} votes)
            </label>
        </li>
        {% endfor %}
    </ul>
    <button type="submit" class="btn btn-success">Vote</button>
</form>
{% else %}
<a href="{{ url_for('forum.create_forum_poll', topic_id=topic.id) }}" class="btn btn-info">Create Poll</a>
{% endif %}

<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
    function imageHandler() {
        let input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();

        input.onchange = () => {
            let file = input.files[0];
            if (file) {
                let formData = new FormData();
                formData.append('file', file);

                // This points to your existing route for image uploads
                fetch("{{ url_for('main.upload_image') }}", {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.url) {
                            let range = quill.getSelection() || { index: quill.getLength() };
                            quill.insertEmbed(range.index, 'image', result.url, Quill.sources.USER);
                            quill.setSelection(range.index + 1);
                        } else {
                            alert("Image upload failed: " + (result.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Image upload error');
                    });
            }
        };
    }

    var quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
            toolbar: {
                container: [
                    [{ 'header': [1, 2, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['link', 'image', 'blockquote', 'code-block'],
                    ['clean']
                ],
                handlers: {
                    image: imageHandler
                }
            }
        }
    });

    quill.on('text-change', function () {
        let html = quill.root.innerHTML.trim();
        document.getElementById('content-textarea').value = html;
    });
</script>
{% endblock %}